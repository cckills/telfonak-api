<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‡ÙˆØ§ØªÙ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f9f9f9; font-family: 'Cairo', sans-serif; }
    .search-modal-box { max-width: 700px; margin: 48px auto; background:#fff; border-radius:14px; padding:24px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    .search-field { width:100%; padding:12px; border:1px solid #e6e6e6; border-radius:10px; font-size:16px; }
    .phone-card img { height:220px; object-fit:cover; border-top-left-radius:10px; border-top-right-radius:10px; }
    .chipset-badge {
      background:#e3f2fd; color:#0d6efd; font-weight:600; padding:4px 10px; border-radius:8px; display:inline-block; font-size:14px;
      cursor:help; position:relative;
    }
    .tooltip-popup {
      position: absolute; background:#222; color:#fff; padding:8px 10px; border-radius:8px; font-size:13px; max-width:300px; z-index:9999;
      box-shadow:0 6px 18px rgba(0,0,0,0.25);
    }
    .tooltip-popup::after { content:""; position:absolute; top:-6px; left:18px; border-width:6px; border-style:solid; border-color:transparent transparent #222 transparent; }
  </style>
</head>
<body>

  <div class="search-modal-box" role="dialog" aria-modal="true">
    <form id="searchForm" class="d-flex gap-2">
      <input id="phoneInput" class="search-field" type="search" name="s" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: y9 Ø£Ùˆ Huawei Y9)" required />
      <button class="btn btn-primary" type="submit">ğŸ” Ø¨Ø­Ø«</button>
    </form>
    <p class="mt-2 text-muted" style="font-size:13px">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø­Ø« Ø£Ùˆ Enter</p>
  </div>

  <div class="container mb-5">
    <div id="result"></div>
  </div>

  <!-- Bootstrap modal -->
  <div class="modal fade" id="specsModal" tabindex="-1" aria-labelledby="specsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="specsModalLabel">Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù‡Ø§ØªÙ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
        </div>
        <div class="modal-body" id="specsModalBody"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const form = document.getElementById("searchForm");
    const input = document.getElementById("phoneInput");
    const resultDiv = document.getElementById("result");

    // Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ÙØ§Ø±ØºØ© Ø¨Ø£Ù…Ø§Ù† ÙÙŠ attributes
    function escapeAttr(s) {
      if (!s) return "";
      return s.replace(/"/g, '&quot;').replace(/'/g, "&#39;");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const phone = input.value.trim();
      if (!phone) return;

      resultDiv.innerHTML = `<div class="alert alert-info">ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "${phone}"...</div>`;

      try {
        const res = await fetch(`/api/${encodeURIComponent(phone)}`);
        const data = await res.json();

        if (data.error) {
          resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }

        // Ù„Ùˆ Ø§Ù„Ù€ API Ø£Ø¹Ø§Ø¯ ØªÙØ§ØµÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
        if (data.mode === "details") {
          openSpecsModalFromDetails(data);
          return;
        }

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        const results = data.results || [];
        if (!results.length) {
          resultDiv.innerHTML = `<div class="alert alert-warning">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù….</div>`;
          return;
        }

        let html = "<div class='row'>";
        for (const item of results) {
          // item.chipset  Ùˆ item.chipsetTooltip Ù…ÙØªØ±Ø¶Ø§ Ø£Ù† ÙŠØ£ØªÙŠ Ø¨Ù‡Ù…Ø§ Ø§Ù„Ù€ API
          const chipsetShort = escapeAttr(item.chipset || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");
          const chipsetFull = escapeAttr(item.chipsetTooltip || "");
          const imgTag = item.img ? `<img src="${item.img}" class="card-img-top" alt="${escapeAttr(item.title)}">` : "";
          const url = escapeAttr(item.link || item.source || "");

          html += `
            <div class="col-md-4 mb-4">
              <div class="card phone-card h-100 shadow-sm">
                ${imgTag}
                <div class="card-body d-flex flex-column">
                  <h6 class="card-title mb-2">${escapeAttr(item.title)}</h6>
                  <p class="text-muted mb-3"><strong>Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬:</strong>
                    <span class="chipset-badge" data-tooltip="${chipsetFull}">${chipsetShort}</span>
                  </p>
                  <button class="btn btn-primary mt-auto" data-url="${url}">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª</button>
                </div>
              </div>
            </div>`;
        }
        html += "</div>";
        resultDiv.innerHTML = html;

      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<div class="alert alert-danger">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>`;
      }
    });

    // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© details
    function openSpecsModalFromDetails(data) {
      const modalBody = document.getElementById("specsModalBody");
      const title = data.title || "";
      const img = data.img || "";
      const specs = data.specs || {};
      let specsHtml = "";
      for (const [k,v] of Object.entries(specs)) {
        specsHtml += `<li><strong>${k}:</strong> ${v}</li>`;
      }
      modalBody.innerHTML = `
        ${img ? `<img src="${img}" class="img-fluid mb-3" style="object-fit:cover;">` : ""}
        <h4>${title}</h4>
        <ul>${specsHtml}</ul>
        <a href="${data.source || '#'}" target="_blank" class="btn btn-outline-primary mt-2">Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ</a>
      `;
      const specsModal = new bootstrap.Modal(document.getElementById('specsModal'));
      specsModal.show();
    }

    // ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‡Ø§ØªÙ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± (delegation)
    resultDiv.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-url]");
      if (!btn) return;
      const url = btn.dataset.url;
      if (!url) return;

      // Ø¶Ø¹ Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      const modalBody = document.getElementById("specsModalBody");
      modalBody.innerHTML = `<div class="alert alert-info">ğŸ“± Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª...</div>`;
      const specsModal = new bootstrap.Modal(document.getElementById('specsModal'));
      specsModal.show(); // Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙÙˆØ±Ø§Ù‹ Ù„ÙŠØ´Ø¹Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©

      try {
        const res = await fetch(`/api/details?url=${encodeURIComponent(url)}`);
        const data = await res.json();
        if (data.error) {
          modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }
        // Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
        let specsHtml = "";
        for (const [k,v] of Object.entries(data.specs || {})) {
          specsHtml += `<li><strong>${k}:</strong> ${v}</li>`;
        }
        modalBody.innerHTML = `
          ${data.img ? `<img src="${data.img}" class="img-fluid mb-3" style="object-fit:cover;">` : ""}
          <h4>${data.title || ""}</h4>
          <ul>${specsHtml}</ul>
          <a href="${data.source || url}" target="_blank" class="btn btn-outline-primary mt-2">ÙØªØ­ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
        `;
      } catch (err) {
        console.error(err);
        modalBody.innerHTML = `<div class="alert alert-danger">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù‡Ø§ØªÙ.</div>`;
      }
    });

    // TOOLTIP: Ø¹Ø±Ø¶ ØªÙ„Ù…ÙŠØ­ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· â€” ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
    let currentTooltip = null;

    function removeTooltip() {
      if (currentTooltip) {
        currentTooltip.remove();
        currentTooltip = null;
      }
    }

    // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø¯Ø¬ (Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„Ù…Ø³) Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø§Ù„Ù…Ø§ÙˆØ³
    document.addEventListener("click", (e) => {
      const badge = e.target.closest(".chipset-badge");
      if (!badge) return;
      const txt = badge.getAttribute("data-tooltip") || "";
      if (!txt) return;
      // toggle: Ø¥Ø°Ø§ Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ø£Ø²Ù„ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø¹Ø±Ø¶
      if (currentTooltip && currentTooltip._for === badge) { removeTooltip(); return; }
      removeTooltip();
      const tip = document.createElement("div");
      tip.className = "tooltip-popup";
      tip.textContent = txt;
      document.body.appendChild(tip);
      const rect = badge.getBoundingClientRect();
      tip.style.top = `${rect.bottom + window.scrollY + 8}px`;
      tip.style.left = `${Math.max(8, rect.left + window.scrollX)}px`;
      tip._for = badge;
      currentTooltip = tip;

      // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±
      setTimeout(() => {
        const onDocClick = (ev) => {
          if (!tip.contains(ev.target) && ev.target !== badge) {
            removeTooltip();
            document.removeEventListener("click", onDocClick);
          }
        };
        document.addEventListener("click", onDocClick);
      }, 10);
    });

    // Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± (desktop)
    document.addEventListener("mouseover", (e) => {
      const badge = e.target.closest(".chipset-badge");
      if (!badge) return;
      const txt = badge.getAttribute("data-tooltip") || "";
      if (!txt) return;
      // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ù„Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ø¯Ø¬
      if (currentTooltip && currentTooltip._for === badge) return;
      removeTooltip();
      const tip = document.createElement("div");
      tip.className = "tooltip-popup";
      tip.textContent = txt;
      document.body.appendChild(tip);
      const rect = badge.getBoundingClientRect();
      tip.style.top = `${rect.bottom + window.scrollY + 8}px`;
      tip.style.left = `${Math.max(8, rect.left + window.scrollX)}px`;
      tip._for = badge;
      currentTooltip = tip;

      badge.addEventListener("mouseleave", () => {
        if (currentTooltip && currentTooltip._for === badge) removeTooltip();
      }, { once: true });
    });

    // Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù…ÙŠØ­ Ø¹Ù†Ø¯ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø§ÙˆØ³ Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„ØµÙØ­Ø©/ØªÙ…Ø±ÙŠØ±
    window.addEventListener("scroll", removeTooltip);
    window.addEventListener("resize", removeTooltip);
  </script>
</body>
</html>
