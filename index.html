<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>بحث عن الهواتف</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f9f9f9; font-family: 'Cairo', sans-serif; }
    .search-modal-box { max-width: 600px; margin: 80px auto; background: #fff; border-radius: 20px; box-shadow: 0 3px 12px rgba(0,0,0,0.1); padding: 30px; }
    .search-field { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 12px; font-size: 18px; }
    .message { margin-top: 10px; color: #777; font-size: 14px; }
    .phone-card img { height: 250px; object-fit: cover; border-top-left-radius: 12px; border-top-right-radius: 12px; }

    .chipset-badge { background: #e3f2fd; color: #0d6efd; font-weight: 600; padding: 4px 10px; border-radius: 8px; display: inline-block; font-size: 14px; cursor: help; transition: background 0.2s; position: relative; }
    .chipset-badge:hover { background: #d0e7ff; }
    .tooltip-popup { position: absolute; background: #333; color: #fff; padding: 8px 10px; border-radius: 8px; font-size: 13px; max-width: 250px; line-height: 1.5; z-index: 9999; box-shadow: 0 4px 10px rgba(0,0,0,0.3); animation: fadeIn 0.15s ease-in-out; }
    .tooltip-popup::after { content: ""; position: absolute; top: -6px; left: 15px; border-width: 6px; border-style: solid; border-color: transparent transparent #333 transparent; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <!-- search box -->
  <div class="search-modal-box" role="dialog" aria-modal="true">
    <form id="searchForm" class="search-form text-center" onsubmit="return false;">
      <input type="search" class="search-field mb-3" id="phoneInput" name="s" placeholder="ابحث عن اسم الهاتف..." required>
      <button type="submit" id="searchBtn" class="btn btn-primary w-100 py-2 fw-bold">🔍 بحث</button>
      <p class="message mt-2">اكتب كلمة البحث ثم اضغط زر البحث أو <em>Enter</em></p>
    </form>
  </div>

  <div class="container">
    <div id="result"></div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="specsModal" tabindex="-1" aria-labelledby="specsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="specsModalLabel">مواصفات الهاتف</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body" id="specsModalBody"></div>
      </div>
    </div>
  </div>

  <!-- bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const form = document.getElementById("searchForm");
    const input = document.getElementById("phoneInput");
    const resultDiv = document.getElementById("result");
    const searchBtn = document.getElementById("searchBtn");

    // helper: render cards
    function renderList(results) {
      let cards = "<div class='row'>";
      for (const item of results) {
        cards += `
          <div class="col-md-4 mb-4">
            <div class="card phone-card shadow h-100">
              ${item.img ? `<img src="${item.img}" class="card-img-top" alt="${item.title}">` : ""}
              <div class="card-body d-flex flex-column">
                <h6 class="card-title">${item.title}</h6>
                <p class="text-muted mb-2">
                  <strong>المعالج:</strong>
                  <span class="chipset-badge" data-tooltip="${item.chipsetTooltip || `المعالج ${item.chipset || 'غير معروف'}`}">
                    ${item.chipset || "غير محدد"}
                  </span>
                </p>
                <!-- type="button" مهم لمنع سلوك submit -->
                <button type="button" class="btn btn-primary mt-auto" data-url="${item.link}">عرض المواصفات</button>
              </div>
            </div>
          </div>`;
      }
      cards += "</div>";
      resultDiv.innerHTML = cards;
    }

    // البحث (يمكن الضغط زر أو Enter)
    async function doSearch() {
      const phone = input.value.trim();
      if (!phone) return;
      resultDiv.innerHTML = `<div class='alert alert-info'>🔍 جاري البحث عن "${phone}"...</div>`;
      try {
        const res = await fetch(`/api/${encodeURIComponent(phone)}`);
        const data = await res.json();
        if (data.error) { resultDiv.innerHTML = `<div class='alert alert-danger'>❌ ${data.error}</div>`; return; }
        if (!data.mode || data.mode === "list") renderList(data.results);
        else if (data.mode === "details") {
          let specsHtml = "";
          for (const [k, v] of Object.entries(data.specs)) specsHtml += `<li><strong>${k}:</strong> ${v}</li>`;
          resultDiv.innerHTML = `
            <div class="card shadow mt-4">
              ${data.img ? `<img src="${data.img}" class="card-img-top" style="height:300px;object-fit:cover;">` : ""}
              <div class="card-body">
                <h4>${data.title}</h4>
                <ul>${specsHtml}</ul>
                <a href="${data.source}" target="_blank" class="btn btn-outline-primary mt-2">عرض على موقع المصدر</a>
              </div>
            </div>`;
        }
      } catch (err) {
        console.error("Search error:", err);
        resultDiv.innerHTML = `<div class='alert alert-danger'>⚠️ حدث خطأ أثناء جلب البيانات.</div>`;
      }
    }

    // وصل الحدث للزر والحقل (Enter)
    searchBtn.addEventListener("click", doSearch);
    form.addEventListener("submit", (e) => { e.preventDefault(); doSearch(); });

    // getDetails يعرض المحتوى داخل المودال
    async function getDetails(url) {
      console.log("getDetails called for:", url);
      const modalBody = document.getElementById("specsModalBody");
      modalBody.innerHTML = `<div class='d-flex align-items-center'><div class="spinner-border me-2" role="status" aria-hidden="true"></div> جارٍ جلب المواصفات...</div>`;
      try {
        const res = await fetch(`/api/details?url=${encodeURIComponent(url)}`);
        const data = await res.json();
        if (data.error) { modalBody.innerHTML = `<div class='alert alert-danger'>❌ ${data.error}</div>`; return; }
        let specsHtml = "";
        for (const [key, val] of Object.entries(data.specs)) specsHtml += `<li><strong>${key}:</strong> ${val}</li>`;
        modalBody.innerHTML = `
          ${data.img ? `<img src="${data.img}" class="img-fluid mb-3" style="object-fit:cover;">` : ""}
          <h4>${data.title}</h4>
          <ul>${specsHtml}</ul>
          <a href="${data.source}" target="_blank" class="btn btn-outline-primary mt-2">عرض على موقع المصدر</a>
        `;
        const specsModal = new bootstrap.Modal(document.getElementById('specsModal'));
        specsModal.show();
      } catch (err) {
        console.error("getDetails error:", err);
        modalBody.innerHTML = `<div class='alert alert-danger'>⚠️ حدث خطأ أثناء جلب البيانات.</div>`;
      }
    }

    // Delegated click listener — أكثر موثوقية لالتقاط أزرار dynamically-added
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-url]");
      if (!btn) return;
      const url = btn.getAttribute("data-url");
      if (!url) {
        console.warn("زر بدون data-url");
        return;
      }
      getDetails(url);
    });

    // tooltips handling (كما في كودك)
    document.addEventListener("click", (e) => {
      const badge = e.target.closest(".chipset-badge");
      if (!badge) return;
      const tooltipText = badge.getAttribute("data-tooltip");
      if (!tooltipText) return;
      document.querySelectorAll(".tooltip-popup").forEach(el => el.remove());
      const tooltip = document.createElement("div");
      tooltip.className = "tooltip-popup";
      tooltip.textContent = tooltipText;
      document.body.appendChild(tooltip);
      const rect = badge.getBoundingClientRect();
      tooltip.style.top = `${rect.bottom + window.scrollY + 10}px`;
      tooltip.style.left = `${rect.left + window.scrollX}px`;
      const closeTooltip = (ev) => {
        if (!tooltip.contains(ev.target) && ev.target !== badge) {
          tooltip.remove();
          document.removeEventListener("click", closeTooltip);
        }
      };
      setTimeout(() => document.addEventListener("click", closeTooltip), 10);
    });

    document.addEventListener("mouseover", (e) => {
      const badge = e.target.closest(".chipset-badge");
      if (!badge) return;
      const tooltipText = badge.getAttribute("data-tooltip");
      if (!tooltipText) return;
      if (badge.dataset.tooltipOpen === "true") return;
      badge.dataset.tooltipOpen = "true";
      const tooltip = document.createElement("div");
      tooltip.className = "tooltip-popup";
      tooltip.textContent = tooltipText;
      document.body.appendChild(tooltip);
      const rect = badge.getBoundingClientRect();
      tooltip.style.top = `${rect.bottom + window.scrollY + 10}px`;
      tooltip.style.left = `${rect.left + window.scrollX}px`;
      badge.addEventListener("mouseleave", () => {
        tooltip.remove();
        badge.dataset.tooltipOpen = "false";
      }, { once: true });
    });

  </script>
</body>
</html>
